<!DOCTYPE html>
<html lang="en" xmlns:data-th="http://www.w3.org/1999/xhtml" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Title</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }

    .search-container {
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background-color: #f0f0f0;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }

    form {
      display: flex;
      flex-wrap: wrap;
    }

    .search-input,
    .search-button {
      padding: 10px;
      margin-right: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .search-button {
      background-color: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    .search-button:hover {
      background-color: #0056b3;
    }

    .theme-container{
      display: flex;
      overflow-x: auto;
      white-space: nowrap;
      align-items: center;
    }

    .theme-icon-container{
      width: 56px;
      height: 48px;
      border: 1px solid #ddd;
      flex-shrink: 0;
    }

    .listing-container {
      margin: 20px auto; /* 중앙 정렬 */
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-start; /* 왼쪽 정렬 */
    }

    .listing-item {
      width: 265px; /* 수정된 부분: listing-item의 너비를 265px로 지정 */
      height: 300px; /* 수정된 부분: listing-item의 높이를 300px로 지정 */
      margin-right: 20px; /* 수정된 부분: 우측 여백 추가 */
      margin-bottom: 20px; /* 수정된 부분: 하단 여백 추가 */
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }

    .listing-item img {
      /* width: 100%; div에 맞추어 이미지의 너비 조절 */
      /* height: 100%; div에 맞추어 이미지의 높이 조절 */
      object-fit: cover;
    }

    .listing-slider {
      position: relative;
      width: 100%; /* 수정된 부분: slider의 너비를 100%로 지정 */
      height: 100%; /* 수정된 부분: slider의 높이를 100%로 지정 */
    }


    /* 여기부터 사진에 있는 버튼 부분 */
    .prev-button,
    .next-button {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 30px;
      height: 30px;
      background-color: rgba(255, 255, 255, 0.5);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      z-index: 2;
      font-size: 20px;
      line-height: 30px;
      color: rgba(0, 0, 0, 0.54);
    }

    .prev-button {
      left: 10px;
    }

    .next-button {
      right: 10px;
    }

    /* .slick-prev:before,
    .slick-next:before {
      content: '<';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .slick-next:before {
      content: '>';
      left: initial;
      right: 50%;
      transform: translate(50%, -50%);
    }
     */
     
    /* 팝업 스타일 */
    .popup {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0, 0, 0);
      background-color: rgba(0, 0, 0, 0.4);
    }

    .popup-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
    }
    
    .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close-button:hover,
    .close-button:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

  </style>
</head>
<body>
<main>
  <section>
    <div class="search-container">
      <h1>어디로 여행 가시나요?</h1>
      <form action="/rentalHome/search" data-th-action="@{search}" id="condition-search" method="get">
        <input class="search-input" type="text" name="regionName" id="location" placeholder="장소 입력">
        <input class="search-input" type="date" name="checkInDate" id="check-in" placeholder="체크인 날짜">
        <input class="search-input" type="date" name="checkOutDate" id="check-out" placeholder="체크아웃 날짜">
        <input class="search-input" type="number" name="capacity" id="guests" placeholder="인원">
        <button class="search-button" type="submit">검색</button>
      </form>
    </div>
  </section>
  <section>
    <div class="theme-container">
      <button onclick="scrollThemes(-100)">&lt;</button>
      <div data-th-each="theme : ${session.themeList}" class="theme-icon-container">
        <a data-th-href="@{theme(themeName=${theme.themeName})}" name="themeName">
          <img data-th-src="@{'https://5ns6sjke2756.edge.naverncp.com/nBMc0TCJiv/theme/' + ${theme.themeName} + .png(type=f,w=24,h=24,faceopt=false,ttype=png)}" alt="테마 이미지">
        </a>
      </div>
      <button class="scroll-right-button" onclick="scrollThemes(100)">&gt;</button>
    </div>
    <div class="filter">
      <button class="filter-button" onclick="openFilterPopup()">필터</button>
    </div>
  </section>
  <section class="slider-container">
    <div class="listing-container">
      <div data-th-each="rentalHome : ${rentalHomeList}" class="listing-item" data-th-object="${rentalHome}">
        <div class="listing-slider">
          <img class="slide-image" data-th-each="photo : ${rentalHome.rentalHomePhotos}"
               data-th-src="@{'https://5ns6sjke2756.edge.naverncp.com/nBMc0TCJiv/rental_home/' + ${photo.uuidPhotoName}(type=f,w=265,h=252,faceopt=false,ttype=jpg)}" alt="숙소 이미지">
          <button class="slide-button prev-button">&lt;</button>
          <button class="slide-button next-button">&gt;</button>
          <span data-th-text="${rentalHome.name}">숙소 이름</span>
          <span data-th-text="${rentalHome.price}">숙소 가격</span>
        </div>
      </div>
    </div>
  </section>
</main>
<div id="filterPopup" class="popup">
  <div class="popup-content">
    <span class="close-button" onclick="closeFilterPopup()">&times;</span>

    <!-- 필터 폼 -->
    <div>
      <h3>숙소 유형</h3>
      <div class="filter-options-home-type" data-th-each="theme : ${session.themeList}">
        <label class="theme-checkbox-label">
          <input type="checkbox" name="theme" data-th-value="${theme.themeName}" data-th-text="${theme.themeName}" data-th-if="${theme.themeNo < 10}">
        </label>
      </div>
    </div>
    <div>
      <h3>테마</h3>
      <div class="filter-options-theme" data-th-each="theme : ${session.themeList}">
        <label class="theme-checkbox-label">
          <input type="checkbox" name="theme" data-th-value="${theme.themeName}" data-th-text="${theme.themeName}" data-th-if="${theme.themeNo >= 10 && theme.themeNo < 100}">
        </label>
      </div>
    </div>
    <div>
      <label for="minPrice">최소 가격:</label>
      <input type="number" id="minPrice" name="minPrice">
      <label for="maxPrice">최대 가격:</label>
      <input type="number" id="maxPrice" name="maxPrice">
    </div>
    <div>
      <h3>편의 시설</h3>
      <div class="filter-options-facility" data-th-each="facility : ${session.facilityList}">
        <label for="rentalHomeFacilities">
          
        </label>
      </div>
    </div>
    <button class="apply-filter-button" onclick="getFilterData()" th:text="${rentalHomeList.size + '개의 숙소 보기'}">버튼</button>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script th:inline="javascript">
  const rentalHomeList = /*[[${rentalHomeList}]]*/ null;
</script>
<script>
  
  function openFilterPopup(){
    document.getElementById("filterPopup").style.display = "block";
  }
  function closeFilterPopup(){
    document.getElementById("filterPopup").style.display = "none";
  }
  
  // 버튼의 텍스트를 업데이트
  function updateButtonLabel(count){
    const button = document.querySelector(".apply-filter-button");
    button.textContent = count+'개의 숙소 보기';
  }
  
  let filteredRentalHomeList = rentalHomeList;
  function getFilterData(){
    let themes = [];
    let checkboxes = document.querySelectorAll('input[name="theme"]:checked');
    checkboxes.forEach(checkbox => {
      themes.push(checkbox.value);
    });
    let minPrice = document.getElementById('minPrice').value;
    let maxPrice = document.getElementById('maxPrice').value;

    // 숙소List filter
    filteredRentalHomeList = Object.values(rentalHomeList).filter(function(rentalHome){
      if( themes != null ){ // theme를 선택했을때, 조건에 맞는 rentalHome return
        return rentalHome.themes.some(theme => themes.includes(theme.themeName)) && rentalHome.price >= minPrice && rentalHome.price <= maxPrice;
      }
      if( themes == null ){ // theme를 선택 안했을때 해당 조건에 맞는 rentalHome return
        return rentalHome.price >= minPrice && rentalHome.price <= maxPrice; 
      }
    });
    
    // 필터링된 숙소의 갯수 업데이트
    updateButtonLabel( filteredRentalHomeList.length );

    // 필터링된 숙소 리스트 업데이트
    updateRentalHomeList(filteredRentalHomeList);

    // 팝업 닫기
    closeFilterPopup();
  }



  function scrollThemes(offset) {
    const container = document.querySelector('.theme-container');

    container.scrollLeft += offset;
  }

  function bindSliderEvents(listItem){
    let $slideImages = listItem.find('.slide-image');
    let currentIndex = 0;

    function showSlide(index){
      $slideImages.hide().eq(index).show();
    }

    function showNextSlide(){
      currentIndex = (currentIndex + 1) % $slideImages.length;
      showSlide(currentIndex);
    }

    function showPreviousSlide(){
      currentIndex = (currentIndex -1 + $slideImages.length) % $slideImages.length;
      showSlide(currentIndex);
    }

    listItem.find('.next-button').off('click').on('click', showNextSlide);
    listItem.find('.prev-button').off('click').on('click', showPreviousSlide);

    showSlide(currentIndex);
  }

  // 각 숙소의 이미지 슬라이더 처리
  $('.listing-item').each(function () {
    const $slideImages = $(this).find('.slide-image');
    let currentIndex = 0;

    function showSlide(index) {
      $slideImages.hide().eq(index).show();
    }

    function showNextSlide() {
      currentIndex = (currentIndex + 1) % $slideImages.length;
      showSlide(currentIndex);
    }

    function showPreviousSlide() {
      currentIndex = (currentIndex - 1 + $slideImages.length) % $slideImages.length;
      showSlide(currentIndex);
    }

    $(this).find('.next-button').click(showNextSlide);
    $(this).find('.prev-button').click(showPreviousSlide);

    showSlide(currentIndex);
  });

  // 숙소 목록 재할당
 function updateRentalHomeList(newRentalHomeList){
  let listContainer = $('.listing-container'); // 가장 바깥 html 태그의 class 아이디
  listContainer.empty();

  newRentalHomeList.forEach(function(rentalHome){ // html을 재할당된 숙소 목록으로 재작성
    let listItem = $( '<div class="listing-item">' );
    let sliderDiv = $( '<div class="listing-slider">' );
    
      rentalHome.rentalHomePhotos.forEach(function(photos){
      let image = $( '<img class="slide-image">' )
      .attr( 'src', 'https://5ns6sjke2756.edge.naverncp.com/nBMc0TCJiv/rental_home/' + photos.uuidPhotoName + '?type=f&w=265&h=252&faceopt=false&ttype=jpg' )
      .attr( 'alt', '숙소이미지' );
      sliderDiv.append(image);
    });
    let imageLeftButton = $('<button class="slide-button prev-button"></button>');
    let imageRightButton = $('<button class="slide-button next-button"></button>');
    let nameSpan = $('<span>').text(rentalHome.name);
    let priceSpan = $('<span>').text(rentalHome.price);
    
    sliderDiv.append(imageLeftButton);
    sliderDiv.append(imageRightButton);
    sliderDiv.append(nameSpan);
    sliderDiv.append(priceSpan);
    listItem.append(sliderDiv);

    listContainer.append(listItem); // html 작성한것 적용
    
    // 사진 슬라이더 이벤트 재할당
    bindSliderEvents(listItem);
  });
 }

 function handleNewRentalHomeList(newRentalHomeList){
  updateRentalHomeList(newRentalHomeList);
 }

 $(document).ready(function(){
  $('.theme-icon-container img').click(function(){
    $.ajax({
      url: '/theme',
      type: 'GET',
      success : function(response){
        handleNewRentalHomeList(response);
      },
      error: function(xhr, status, error){
        console.error(error);
      }
    });
  });
 });

</script>
</body>
</html>
