<!DOCTYPE html>
<html lang="en" xmlns:data-th="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>숙소 기본 정보 입력</title>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
  <link rel="stylesheet" type="text/css" href="/css/common.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

  <style>
    * {
      font-family: "Noto Sans KR";
      font-weight: 400;
    }

    #main-container {
      text-align: center;
      font-size: 20px;
      padding-top: 20px;
      border: 0.5px solid #CCCCCC;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }

    .info {
      margin 100px 0;
    }

    .input-file-button:hover {
      background-color: #1C9189;
    }

    .image-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      padding: 20px;
      border: 0.5px solid #ddd;
      border-radius: 8px;
      box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.2);
      min-height: 282px;
    }

    .image-wrapper {
      display: flex;
      flex-direction: column;
      margin: auto 0;
      position: relative;
      width: calc(20% - 16px);
    }

    .image-item {
      width: 100%;
      max-height: 220px;
      min-height: 220px;
      object-fit: cover;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .image-description {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      color: #555;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
      margin: 10px 0 0 0 !important;
    }

    .delete-button {
        background-color: red;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        position: absolute;
        top: 0;
        right: 0;
        border-radius: 5px;
    }

    .basic-info {
      width: 50%;
    }

    .location-info {
      width: 50%;
    }


    .input-file-button{
      padding: 6px 25px;
      background-color:#35C5B3;
      border-radius: 4px;
      color: white;
      cursor: pointer;
    }


    .room-theme,
    .room-type {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      width: 60%;
      margin: 30px auto;
    }

    .type-option {
      flex: 1 1 calc(20% - 10px);
      width: 100px;
      height: 100px;
      border: 2px solid #CCCCCC;
      border-radius: 10px;
      margin-right: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      padding: 10px 0;
      justify-content: center;
    }

    .theme-option {
      flex: 1 1 calc(20% - 10px);
      width: 60%;
      border: 2px solid #CCCCCC;
      border-radius: 10px;
      margin-right: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      padding: 10px 0;
      justify-content: center;
    }

    .icon {
      border-radius: 5px;
    }

    input[type="checkbox"],
    input[type="radio"] {
      display: none;
      -webkit-appearance: none; /* Chrome, Safari, Edge 등의 웹킷 기반 브라우저 */
      -moz-appearance: none; /* Firefox 브라우저 */
      appearance: none; /* 일반적인 브라우저 */
    }

    .theme-option.selected,
    .type-option.selected {
      border: 4px solid #35C5B3;
    }

    #basic-facility {
        display: flex;
        justify-content: center;
        flex-direction: column;
        text-align: center;
        margin: 25px auto;
      }

      .convenience-facility {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        width: 60%;
        margin: 25px auto;

      }

      .facility-option {
        flex: 1 1 calc(20% - 10px);
        width: 100px;
        height: 100px;
        border: 2px solid #CCCCCC;
        border-radius: 10px;
        margin-right: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        padding: 10px 0;
        justify-content: center;
      }

      .quantity {
        margin: 20px auto;
        font-size: 20px;
        border-bottom: 2px solid #CCCCCC;
        padding-bottom: 30px;
        max-width: 550px;
        text-align: center;
      }

      input[type=number]::-webkit-inner-spin-button,
      input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;/* input type:number 마우스오버시 보이는 화살표 제거 */
      }

      .fa-solid {
        font-size: 25px;
        margin: 15px;
      }

      .facility-option.selected {
        border-color: #35C5B3;
      }

    /* 지도 */
    #map {
        height: 600px;
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    textarea,
    input[type=text],
    input[type=date],
    input[type=number] {
      background-color: #fff;
      border: 0;
      border-radius: 2px;
      box-shadow: 0 1px 4px -1px rgba(0, 0, 0, 0.3);
      margin: 10px;
      padding: 0.5em;
      overflow: hidden;
      font-size: 16px;
      min-width: 25%;
    }

    input[type=button] {
      background-color: #fff;
      border: 0;
      border-radius: 2px;
      box-shadow: 0 1px 4px -1px rgba(0, 0, 0, 0.3);
      margin: 10px;
      padding: 0.5em;
      font-weight: 200;
      overflow: hidden;
      cursor: pointer;
      font-size: 15px;
      margin-left: 5px;
    }

    input[type=button]:hover {
      background: rgb(235, 235, 235);
    }

    input[type=button].button-primary {
      background-color: #35C5B3;
      color: white;
    }

    input[type=button].button-primary:hover {
      background-color: #1765cc;
    }

    input[type=button].button-secondary {
      background-color: white;
      color: #35C5B3;
    }

    input[type=button].button-secondary:hover {
      background-color: #d2e3fc;
    }
    #response {
      margin: 5px;
      font-size: 15px;
    }

    #response-container {
      background-color: #fff;
      border: 0;
      border-radius: 2px;
      box-shadow: 0 1px 4px -1px rgba(0, 0, 0, 0.3);
      padding: 0 0.5em;
      font: 400 18px Roboto, Arial, sans-serif;
      overflow: hidden;
      margin: 10px;
      overflow: auto;
      max-width: 90%;
      background-color: rgba(255, 255, 255, 0.95);
      font-size: small;
    }

    #instructions {
      background-color: #fff;
      border: 0;
      border-radius: 2px;
      box-shadow: 0 1px 4px -1px rgba(0, 0, 0, 0.3);
      margin: 10px;
      padding: 0.5em;
      font: 400 18px Roboto, Arial, sans-serif;
      overflow: hidden;
      padding: 1rem;
      font-size: medium;
    }

    .input-file-button,
    button[type="submit"] {
      background-color: #35C5B3;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin: 20px 0 40px 0;
    }

    #nextButton.disabled {
      background-color: #aaa;
    }

    #nextButton.enabled {
      background-color: #35C5B3;
    }

    #nextButton.enabled:hover {
      background-color: #2A9D8F;
    }

  </style>
<body>

<div data-th-replace="host/hostHeader :: hostHeader">머리말</div>
<br>

<div id="main-container" class="container-sm">
  <form id="myForm" enctype="multipart/form-data" method='post'>

    <div class="info">
      <h1>숙소 기본 정보</h1>
      <br>
      <div>
        <input class="basic-info" type="text" name="name" id="name" placeholder="숙소명">
      </div>
      <div>
        <textarea class="basic-info" name="explanation" id="explanation"
                  placeholder="숙소 설명"></textarea>
      </div>
      <div>
        <textarea class="basic-info" name="rentalHomeRule" id="rentalHomeRule"
                  placeholder="숙소 이용규칙"></textarea>
      </div>
    </div>
    <br><br>

    <div class="info">
      <h1>숙소 위치</h1>
      <br>
      <section>
        <div id="map"></div>
      </section>

      <input type="hidden" name="lat" id="lat">
      <input type="hidden" name="lon" id="lon">
      <br>
      <div>
        <input class="location-info" type="text"  name="basicAddress" id="basicAddress"
               placeholder="기본 주소">
      </div>
      <div>
        <input class="location-info" type="text"  name="detailAddress" id="detailAddress"
               placeholder="상세 주소">
      </div>
    </div>
    <br><br>


    <div class="info">
    <h1>숙소 사진</h1>
      <h4>5장 이상의 사진을 선택해주세요.</h4>
      <br>
      <label class="input-file-button" for="photoInput">사진 추가</label>
      <br><br>
      <input type="file" multiple id="photoInput" name="photos" style="display:none;"
             onchange="photoCountAndDisplay(this.files)"/>
      <div class="image-container">
        <div class="image-wrapper" id="default-image">
          <img src="https://5ns6sjke2756.edge.naverncp.com/nBMc0TCJiv/icon/camera.png?type=w_sh&w=150&quality=100&sharp_amt=1.0&ttype=png">
        </div>
      </div>
    </div>
    <br><br>

    <div class="info">
      <h1>요금설정</h1>
      <br>
      <script>
        function calc() {
          const price = Number(document.getElementById("price").value);
          const cleanFee = Number(document.getElementById("cleanFee").value)
          document.getElementById("income").value = Math.round((price + cleanFee) * 0.97)
        }
      </script>
      <div>
        <input class="price-info" type="number" name="price" id="price" placeholder="이용요금(주 기준)"
               onkeyup="calc(this.value)">
      </div>
      <div>
        <input class="price-info" type="number" name="cleanFee" id="cleanFee" placeholder="청소비"
               onkeyup="calc(this.value)">
      </div>
      <div>
        <input class="price-info" readonly type="text" id="income" placeholder="정산금액">
      </div>
    </div>
    <br><br>
    <div class="info">
      <div class="duration-item">
        <h1>호스팅 기간</h1>
        <br>
        호스팅 시작일: <input class="hostingDate" name='hostingStartDate' id="hostingStartDate" type='date'>
      </div>
      <div class="duration-item">
        호스팅 종료일: <input class="hostingDate" name='hostingEndDate' id="hostingEndDate" type='date'>
      </div>
    </div>
  </form>
  <br><br>

  <div>
    <button id="nextButton" type="submit" onclick="submitForm()">다음</button>
  </div>

</div>
<br><br>

<div data-th-replace="footer :: footer">꼬리말</div>
<script>
  let filesArray = []; // 이미지 배열
  let formData = new FormData(); // 폼데이터

  function checkRequiredFields() {
  // 필수 입력 필드 목록
  let requiredFields = [
    document.getElementById('name'),
    document.getElementById('explanation'),
    document.getElementById('rentalHomeRule'),
    document.getElementById('basicAddress'),
    document.getElementById('detailAddress'),
    document.getElementById('price'),
    document.getElementById('cleanFee'),
    document.getElementById('hostingStartDate'),
    document.getElementById('hostingEndDate')
  ];

  // 필수 입력 필드가 비어 있는지 확인
  let isEmpty = requiredFields.some(field => !field.value.trim());

  let isDescriptionEmpty = filesArray.some(file => !file.description.value.trim());

  // 다음 버튼 가져오기
  const nextButton = document.querySelector('#nextButton');

  // 필수 입력 필드가 비어 있으면 다음 버튼을 비활성화
  if (isEmpty || filesArray.length < 5 || isDescriptionEmpty) {
    nextButton.disabled = true;
    nextButton.classList.add('disabled');
    nextButton.classList.remove('enabled');
  } else {
    nextButton.disabled = false;
    nextButton.classList.add('enabled');
    nextButton.classList.remove('disabled');
  }
}

  // 페이지 로드 시, 입력 필드가 변경될 때마다 확인
  window.onload = function() {
    // 입력 필드가 변경될 때마다 확인
    document.querySelectorAll('input, textarea').forEach(element => {
      element.addEventListener('input', checkRequiredFields);
    });


    // 초기에도 확인
    checkRequiredFields();
  };

  function submitForm() {
    formData.append('name', document.querySelector('#name').value);
    formData.append('explanation', document.querySelector('#explanation').value);
    formData.append('rentalHomeRule', document.querySelector('#rentalHomeRule').value);

    let basicAddress = document.querySelector('#basicAddress').value;
    let detailAddress = document.querySelector('#detailAddress').value;

    formData.append('address', basicAddress + "." + detailAddress);
    formData.append('lat', document.querySelector('#lat').value);
    formData.append('lon', document.querySelector('#lon').value);

    formData.append('price', document.querySelector('#price').value);
    formData.append('cleanFee', document.querySelector('#cleanFee').value);
    formData.append('hostingStartDate', document.querySelector('#hostingStartDate').value);
    formData.append('hostingEndDate', document.querySelector('#hostingEndDate').value);

    updateFormData(); // FormData 업데이트


    fetch('rentalHomeSave', {
      method: 'POST',
      body: formData

    }).then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.text();

    }).then(data => {
      window.location.href = "themeForm"; // 자동으로 리디렉션

    }).catch(error => {
      console.error('Error:', error);
    });
  }

  // FormData 업데이트 함수
  function updateFormData() {
    filesArray.forEach(obj => {
      formData.append('photos', obj.file);
      formData.append('photoExplanations', obj.description.value);
    });
  }

  function photoCountAndDisplay(files) {
    let imageContainer = document.querySelector('.image-container');
    let defaultImage = document.querySelector('#default-image');

    defaultImage.style.display = 'none';
    imageContainer.style.justifyContent = 'flex-start';

    for (var i = 0; i < files.length; i++) {
      let file = files[i];
      var reader = new FileReader();

      reader.onload = function (e) {
        var wrapper = document.createElement('div');
        wrapper.classList.add('image-wrapper');

        var imgElement = document.createElement('img');
        imgElement.classList.add('image-item');
        imgElement.src = e.target.result;
        wrapper.appendChild(imgElement);

        var descriptionInput = document.createElement('input');
        descriptionInput.type = 'text';
        descriptionInput.placeholder = '이미지 설명';
        descriptionInput.classList.add('image-description');
        descriptionInput.name = 'photoExplanations'; // 이미지 설명의 이름 설정
        wrapper.appendChild(descriptionInput);

        var deleteButton = document.createElement('button');
        deleteButton.textContent = 'X';
        deleteButton.classList.add('delete-button');
        deleteButton.onclick = function () {
          var index = filesArray.findIndex(obj => obj.file === file);
          if (index > -1) {
            filesArray.splice(index, 1);
            checkRequiredFields();
            wrapper.remove();
          }

          let imageContainer = document.querySelector('.image-container');
          let wrapperCount = document.querySelectorAll('.image-wrapper').length;
          let defaultImage = document.querySelector('#default-image');

          if (wrapperCount === 1) {
            defaultImage.style.display = 'block';
            imageContainer.style.justifyContent = 'center';
          }
        };
        wrapper.appendChild(deleteButton);

        imageContainer.appendChild(wrapper);

        // 파일과 설명을 하나의 객체로 연결하여 배열에 추가
        filesArray.push({
          file: file,
          description: descriptionInput
        });

        descriptionInput.addEventListener('input', checkRequiredFields);
        checkRequiredFields();
      };

      reader.readAsDataURL(file);
    }
  }
</script>

<script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCn7sXQ-7jFww0vK_pndKEMLEsJfMxAsmk&callback=initMap&v=weekly"
    defer>
</script>
<script>
  let map;
  let marker;
  let geocoder;
  let responseDiv;
  let response;
  let selectedLocation;
  let address;

  // google맵 생성
  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 10,
      center: { lat: 37.5518911, lng: 126.9917937 },
      mapTypeControl: false,
    });
    geocoder = new google.maps.Geocoder();

    // 맵 안쪽에 들어갈 html -- 검색 창 및 버튼
    const inputText = document.createElement("input");

    inputText.type = "text";
    inputText.placeholder = "주소";
    inputText.id = "mapInput";

    inputText.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
          geocode({ address: this.value });
        }
    });

    const submitButton = document.createElement("input");

    submitButton.type = "button";
    submitButton.value = "검색";
    submitButton.classList.add("button", "button-primary");

    const clearButton = document.createElement("input");

    clearButton.type = "button";
    clearButton.value = "초기화";
    clearButton.classList.add("button", "button-secondary");

    const selectButton = document.createElement("input");

    selectButton.type = "button";
    selectButton.value = "선택";
    selectButton.classList.add("button", "button-primary");
    selectButton.id = "select-button";

    response = document.createElement("pre");
    response.id = "response";
    response.innerText = "";
    responseDiv = document.createElement("div");
    responseDiv.id = "response-container";
    responseDiv.appendChild(response);


    map.controls[google.maps.ControlPosition.TOP_LEFT].push(inputText); // 주소 입력 박스
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(submitButton); // 주소 가져오기 버튼
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(clearButton); // 초기화 버튼
    map.controls[google.maps.ControlPosition.LEFT_TOP].push(responseDiv); // 주소 변환 결과값 출력 공간
    map.controls[google.maps.ControlPosition.RIGHT_TOP].push(selectButton);
    marker = new google.maps.Marker({
      map,
    });

    map.addListener("click", (e) => {
     geocode({ location: e.latLng });
    });

    submitButton.addEventListener("click", () =>
     geocode({ address: inputText.value })
    );

    clearButton.addEventListener("click", () => {
      clear();
    });

    selectButton.addEventListener("click", () => {
      let addressInput =  document.getElementById('basicAddress');
      let detailAddressInput = document.getElementById('detailAddress');
      let lat = document.getElementById("lat");
      let lon = document.getElementById('lon');

      addressInput.value = address;
      detailAddressInput.value = null;
      lat.value = selectedLocation.lat();
      lon.value = JSON.stringify(selectedLocation.lng());
    });

    clear();
  }

  // 초기화
  function clear() {
    marker.setMap(null);
    responseDiv.style.display = "none";
  }

  // 주소 변환
  function geocode(request) {
    clear();
    geocoder
      .geocode(request)
      .then((result) => {
        const { results } = result;

        map.setCenter(results[0].geometry.location);
        marker.setPosition(results[0].geometry.location);
        marker.setMap(map);
        responseDiv.style.display = "block";

        address = results[0].formatted_address;
        selectedLocation = results[0].geometry.location;
        response.innerText = JSON.stringify(results[0].formatted_address, null, 2);
        return results;
      })
      .catch((e) => {
        responseDiv.style.display = "block";
        response.innerText = "검색결과가 없습니다.";
      });
  }

  window.initMap = initMap;
</script>

</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script data-th-src="@{/js/host/hostHeader.js}"></script>


</html>