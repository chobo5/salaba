<!DOCTYPE html>
<html lang="en" xmlns:data-th="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>숙소 기본 정보 입력</title>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
  <style>
    .image-container {
      display: inline-block;
      text-align: center;
      margin-right: 20px;
      margin-top: 30px;
      position: relative;
    }
    .image-item {
      width: 265px;
      height: 252px;
      object-fit: cover;
      margin-bottom: 10px;
      position: relative; /* 이미지 상대 위치 설정 */
    }

    .image-description {
        width: 100%;
        box-sizing: border-box;
        position: absolute;
        bottom: 0;
        left: 0;
        margin: 0;
        padding: 5px;
    }

    .delete-button {
        background-color: red;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        position: absolute;
        top: 0; /* 이미지의 위쪽 여백 */
        right: 0; /* 이미지의 오른쪽 여백 */
        transform: translate(50%, -50%); /* 삭제 버튼을 이미지의 오른쪽 상단에 정확히 위치시키기 위해 */
    }

    .input-file-button,
    button[type="submit"] {
      background-color: #35C5B3;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .input-file-button:hover,
    button[type="submit"]:hover {
      background-color: #1C9189;
    }

    /* 지도 */
    #map {
    height: 513px;
    width: 912px;
    border-radius: 4px;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    textarea,
    input[type=text],
    input[type=number] {
      background-color: #fff;
      border: 0;
      border-radius: 2px;
      box-shadow: 0 1px 4px -1px rgba(0, 0, 0, 0.3);
      margin: 10px;
      padding: 0 0.5em;
      font: 400 18px Roboto, Arial, sans-serif;
      overflow: hidden;
      line-height: 40px;
      margin-right: 0;
      min-width: 25%;
    }

    input[type=button] {
      background-color: #fff;
      border: 0;
      border-radius: 2px;
      box-shadow: 0 1px 4px -1px rgba(0, 0, 0, 0.3);
      margin: 10px;
      padding: 0 0.5em;
      font: 400 18px Roboto, Arial, sans-serif;
      overflow: hidden;
      height: 40px;
      cursor: pointer;
      margin-left: 5px;
    }
    input[type=button]:hover {
      background: rgb(235, 235, 235);
    }


    input[type=button].button-primary {
      background-color: #35C5B3;
      color: white;
    }
    input[type=button].button-primary:hover {
      background-color: #1765cc;
    }
    input[type=button].button-secondary {
      background-color: white;
      color: #35C5B3;
    }
    input[type=button].button-secondary:hover {
      background-color: #d2e3fc;
    }

    #response-container {
      background-color: #fff;
      border: 0;
      border-radius: 2px;
      box-shadow: 0 1px 4px -1px rgba(0, 0, 0, 0.3);
      margin: 10px;
      padding: 0 0.5em;
      font: 400 18px Roboto, Arial, sans-serif;
      overflow: hidden;
      overflow: auto;
      max-height: 50%;
      max-width: 90%;
      background-color: rgba(255, 255, 255, 0.95);
      font-size: small;
    }

    #instructions {
      background-color: #fff;
      border: 0;
      border-radius: 2px;
      box-shadow: 0 1px 4px -1px rgba(0, 0, 0, 0.3);
      margin: 10px;
      padding: 0 0.5em;
      font: 400 18px Roboto, Arial, sans-serif;
      overflow: hidden;
      padding: 1rem;
      font-size: medium;
    }
  </style>
<body>

<div data-th-replace="host/hostHeader :: hostHeader">머리말</div>

<div align="center">
  <form id="myForm" enctype="multipart/form-data" method='post'>
    <br>

    <h2>숙소 기본 정보</h2>
    <div>
      <input style="width:500px" type="text" name="name" id="name" placeholder="숙소명" required>
    </div>
    <div>
      <textarea style="width:500px" name="explanation" id="explanation"
                placeholder="숙소 설명" required></textarea>
    </div>
    <div>
      <textarea style="width:500px" name="rentalHomeRule" id="rentalHomeRule"
                placeholder="숙소 이용규칙" required></textarea>
    </div>

    <br>
    <br>
    <br>

    <h2>숙소 위치</h2>
    <section>
      <div id="map"></div>
    </section>

    <input type="text" name="lat" id="lat">
    <input type="text" name="lon" id="lon">
    <div>
      <input type="text" style="width:500px" name="basicAddress" id="basicAddress"
             placeholder="기본 주소" required>
    </div>
    <div>
      <input type="text" style="width:500px" name="detailAddress" id="detailAddress"
             placeholder="상세 주소" required>
    </div>
    <br>
    <br>
    <br>

    <h2>숙소 사진</h2>

    <div>
      <label class="input-file-button" for="photoInput">사진 추가</label>
      <input type="file" multiple id="photoInput" name="photos" style="display:none;"
             onchange="photoCountAndDisplay(this.files)" required/>
      <div id="imageContainer"></div>
    </div>

    <br>
    <br>
    <br>

    <h2>요금설정</h2>
    <script>
      function calc() {
        const price = Number(document.getElementById("price").value);
        const cleanFee = Number(document.getElementById("cleanFee").value)
        document.getElementById("income").value = Math.round((price + cleanFee) * 0.97)
      }
    </script>
    <div>
      <input style="width:500px" type="number" name="price" id="price" placeholder="이용요금(주 기준)"
             onkeyup="calc(this.value)" required>
    </div>
    <div>
      <input style="width:500px" type="number" name="cleanFee" id="cleanFee" placeholder="청소비"
             onkeyup="calc(this.value)" required>
    </div>
    <div>
      <input style="width:500px" readonly type="text" id="income" placeholder="정산금액">
    </div>


    <br>
    <br>
    <br>

    <h2>호스팅 기간</h2>
    <div>
      호스팅 시작일: <input name='hostingStartDate' id="hostingStartDate" type='date' required>
    </div>
    <div>
      호스팅 종료일: <input name='hostingEndDate' id="hostingEndDate" type='date' required>
    </div>


    <br>
    <br>
    <br>

  </form>

  <div>
    <button type="submit" onclick="submitForm()">다음</button>
  </div>

  <br>
  <br>
</div>


<div data-th-replace="footer :: footer">꼬리말</div>
<script>
  function checkRequiredFields() {
  // 필수 입력 필드 목록
  const requiredFields = [
    document.getElementById('name'),
    document.getElementById('explanation'),
    document.getElementById('rentalHomeRule'),
    document.getElementById('basicAddress'),
    document.getElementById('detailAddress'),
    document.getElementById('price'),
    document.getElementById('cleanFee'),
    document.getElementById('hostingStartDate'),
    document.getElementById('hostingEndDate')
  ];

  // 필수 입력 필드가 비어 있는지 확인
  const isEmpty = requiredFields.some(field => !field.value.trim());

  // 다음 버튼 가져오기
  const nextButton = document.querySelector('button[type="submit"]');

  // 필수 입력 필드가 비어 있으면 다음 버튼을 비활성화
  if (isEmpty) {
    nextButton.disabled = true;
    nextButton.style.backgroundColor = '#CCCCCC';
  } else {
    nextButton.disabled = false;
    nextButton.style.backgroundColor = '#35C5B3'; // 활성화된 배경색
  }
}

// 페이지 로드 시, 입력 필드가 변경될 때마다 확인
window.onload = function() {
  // 입력 필드가 변경될 때마다 확인
  document.querySelectorAll('input, textarea').forEach(element => {
    element.addEventListener('input', checkRequiredFields);
  });

  // 초기에도 확인
  checkRequiredFields();
};

  var filesArray = []; // 이미지 배열
  var formData = new FormData(); // 폼데이터

  function submitForm() {
    formData.append('name', document.querySelector('#name').value);
    formData.append('explanation', document.querySelector('#explanation').value);
    formData.append('rentalHomeRule', document.querySelector('#rentalHomeRule').value);

    let basicAddress = document.querySelector('#basicAddress').value;
    let detailAddress = document.querySelector('#detailAddress').value;

    formData.append('address', basicAddress + ". " + detailAddress);
    formData.append('lat', document.querySelector('#lat').value);
    formData.append('lon', document.querySelector('#lon').value);

    formData.append('price', document.querySelector('#price').value);
    formData.append('cleanFee', document.querySelector('#cleanFee').value);
    formData.append('hostingStartDate', document.querySelector('#hostingStartDate').value);
    formData.append('hostingEndDate', document.querySelector('#hostingEndDate').value);

    updateFormData(); // FormData 업데이트

    console.log(formData.getAll('photoExplanations'));
    console.log(formData.getAll('photos'));

    fetch('rentalHomeSave', {
      method: 'POST',
      body: formData

    }).then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.text();

    }).then(data => {
      console.log('Response data:', data);
      window.location.href = "themeForm"; // 자동으로 리디렉션

    }).catch(error => {
      console.error('Error:', error);
    });
  }

  // FormData 업데이트 함수
  function updateFormData() {
    filesArray.forEach(obj => {
      formData.append('photos', obj.file);
      formData.append('photoExplanations', obj.description.value);
    });
  }

  function photoCountAndDisplay(files) {
    var imageContainer = document.getElementById('imageContainer');

    for (var i = 0; i < files.length; i++) {
      let file = files[i];
      var reader = new FileReader();

      reader.onload = function (e) {
        var container = document.createElement('div');
        container.classList.add('image-container');

        var imgElement = document.createElement('img');
        imgElement.classList.add('image-item');
        imgElement.src = e.target.result;
        container.appendChild(imgElement);

        var descriptionInput = document.createElement('input');
        descriptionInput.type = 'text';
        descriptionInput.placeholder = '이미지 설명';
        descriptionInput.classList.add('image-description');
        descriptionInput.name = 'photoExplanations'; // 이미지 설명의 이름 설정
        container.appendChild(descriptionInput);

        var deleteButton = document.createElement('button');
        deleteButton.textContent = 'X';
        deleteButton.classList.add('delete-button');
        deleteButton.onclick = function () {
          var index = filesArray.findIndex(obj => obj.file === file);
          if (index > -1) {
            filesArray.splice(index, 1);
            container.remove();
          }
        };
        container.appendChild(deleteButton);

        imageContainer.appendChild(container);

        // 파일과 설명을 하나의 객체로 연결하여 배열에 추가
        filesArray.push({
          file: file,
          description: descriptionInput
        });
      };

      reader.readAsDataURL(file);
    }
  }
</script>

<script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCn7sXQ-7jFww0vK_pndKEMLEsJfMxAsmk&callback=initMap&v=weekly"
    defer>
</script>
<script>
  let map;
  let marker;
  let geocoder;
  let responseDiv;
  let response;
  let selectedLocation;
  let address;

  // google맵 생성
  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 10,
      center: { lat: 37.5518911, lng: 126.9917937 },
      mapTypeControl: false,
    });
    geocoder = new google.maps.Geocoder();

    // 맵 안쪽에 들어갈 html -- 검색 창 및 버튼
    const inputText = document.createElement("input");

    inputText.type = "text";
    inputText.placeholder = "Enter a location";

    const submitButton = document.createElement("input");

    submitButton.type = "button";
    submitButton.value = "검색";
    submitButton.classList.add("button", "button-primary");

    const clearButton = document.createElement("input");

    clearButton.type = "button";
    clearButton.value = "초기화";
    clearButton.classList.add("button", "button-secondary");

    const selectButton = document.createElement("input");

    selectButton.type = "button";
    selectButton.value = "선택";
    selectButton.classList.add("button", "button-primary");
    selectButton.id = "select-button";

    response = document.createElement("pre");
    response.id = "response";
    response.innerText = "";
    responseDiv = document.createElement("div");
    responseDiv.id = "response-container";
    responseDiv.appendChild(response);


    map.controls[google.maps.ControlPosition.TOP_LEFT].push(inputText); // 주소 입력 박스
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(submitButton); // 주소 가져오기 버튼
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(clearButton); // 초기화 버튼
    map.controls[google.maps.ControlPosition.LEFT_TOP].push(responseDiv); // 주소 변환 결과값 출력 공간
    map.controls[google.maps.ControlPosition.RIGHT_TOP].push(selectButton);
    marker = new google.maps.Marker({
      map,
    });

    map.addListener("click", (e) => {
     geocode({ location: e.latLng });
    });

    submitButton.addEventListener("click", () =>
     geocode({ address: inputText.value })
    );

    clearButton.addEventListener("click", () => {
      clear();
    });

    selectButton.addEventListener("click", () => {
      let addressInput =  document.getElementById('basicAddress');
      let detailAddressInput = document.getElementById('detailAddress');
      let lat = document.getElementById("lat");
      let lon = document.getElementById('lon');

      addressInput.value = address;
      detailAddressInput.value = null;
      lat.value = selectedLocation.lat();
      lon.value = JSON.stringify(selectedLocation.lng());
    });

    clear();
  }

  // 초기화
  function clear() {
    marker.setMap(null);
    responseDiv.style.display = "none";
  }

  // 주소 변환
  function geocode(request) {
    clear();
    geocoder
      .geocode(request)
      .then((result) => {
        const { results } = result;

        map.setCenter(results[0].geometry.location);
        marker.setPosition(results[0].geometry.location);
        marker.setMap(map);
        responseDiv.style.display = "block";

        address = results[0].formatted_address;
        selectedLocation = results[0].geometry.location;
        response.innerText = JSON.stringify(results[0].formatted_address, null, 2);
        return results;
      })
      .catch((e) => {
        responseDiv.style.display = "block";
        response.innerText = "검색결과가 없습니다.";
      });
  }

  window.initMap = initMap;
</script>


</body>

</html>