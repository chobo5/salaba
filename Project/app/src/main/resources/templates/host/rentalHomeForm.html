<!DOCTYPE html>
<html lang="en" xmlns:data-th="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>숙소 기본 정보 입력</title>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
  <link rel="stylesheet" type="text/css" href="/css/common.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

  <style>
    * {
      font-family: "Noto Sans KR";
      font-weight: 400;
    }

    #main-container {
      text-align: center;
      align-items: center;
      font-size: 20px;
    }

    .info {
      margin: 50px 0 220px 0;
    }

    .basic-info {
      width: 500px;
    }

    .location-info {
      width: 50%;
      margin: 0 auto;
    }

    .duration-info {
      margin: 25px 0;
    }

    .image-container {
      display: inline-block;
      text-align: center;
      margin: 20px;
      position: relative;
      max-width: 690px;
    }

    .image-item {
      width: 256px;
      height: 230px;
      object-fit: cover;
      margin-bottom: 10px;
      position: relative;
      border-radius: 5px;
    }

    .image-description {
        width: 100%;
        position: absolute;
        bottom: -20px;
        left: 0;
        margin: 0;
    }

    .delete-button {
        background-color: red;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        position: absolute;
        top: 0;
        right: 0;
        border-radius: 5px;
    }



    .input-file-button,
    button[type="submit"] {
      background-color: #35C5B3;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin: 50px 0 100px 0;
    }

    .input-file-button:hover,
    button[type="submit"]:hover {
      background-color: #1C9189;
    }

    #nextButton {
      margin: 250px 0 50px 0;
    }


    /* 지도 */
    #map {
      height: 600px;
      border-radius: 5px;
      width: 65%;
      margin: 0 auto;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    textarea,
    input[type=text],
    input[type=date],
    input[type=number] {
      background-color: #fff;
      border: 0;
      border-radius: 2px;
      box-shadow: 0 1px 4px -1px rgba(0, 0, 0, 0.3);
      margin: 10px 0 10px 0;
      padding: 0 0.5em;
      overflow: hidden;
      line-height: 40px;
      margin-right: 0;
      min-width: 25%;
      font-size: 16px;
    }

    #hostingStartDate,
    #hostingEndDate, {
      max-width: 10%;
    }

    input[type=button] {
      background-color: #fff;
      border: 0;
      border-radius: 2px;
      box-shadow: 0 1px 4px -1px rgba(0, 0, 0, 0.3);
      margin: 10px;
      padding: 0 0.5em;
      overflow: hidden;
      height: 40px;
      cursor: pointer;
      margin-left: 5px;
      font-size: 16px;
    }
    input[type=button]:hover {
      background: rgb(235, 235, 235);
    }


    input[type=button].button-primary {
      background-color: #35C5B3;
      color: white;
    }
    input[type=button].button-primary:hover {
      background-color: #1765cc;
    }
    input[type=button].button-secondary {
      background-color: white;
      color: #35C5B3;
    }
    input[type=button].button-secondary:hover {
      background-color: #d2e3fc;
    }

    #mapInput {
      margin-left: 10px;

    }

    .duration-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .duration-item {
      flex-basis: 48%;
      max-width: 16%;
    }

    .duration-item label {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #555;
      margin-bottom: 10px;
    }

    .hostingDate {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px;
    }

    #response-container {
      background-color: #fff;
      border: 0;
      border-radius: 2px;
      box-shadow: 0 1px 4px -1px rgba(0, 0, 0, 0.3);
      margin: 10px;
      padding: 0 0.5em;
      overflow: hidden;
      overflow: auto;
      max-height: 50%;
      max-width: 90%;
      background-color: rgba(255, 255, 255, 0.95);
      font-size: small;
    }

    #instructions {
      background-color: #fff;
      border: 0;
      border-radius: 2px;
      box-shadow: 0 1px 4px -1px rgba(0, 0, 0, 0.3);
      margin: 10px;
      padding: 0 0.5em;
      overflow: hidden;
      padding: 1rem;
      font-size: medium;
    }

    h4 {
        font-size: 20px;
        font-weight: 600;
        color: #555;
        margin-bottom: 10px;
    }
  </style>
<body>

<div data-th-replace="host/hostHeader :: hostHeader">머리말</div>

<div id="main-container">
  <form id="myForm" enctype="multipart/form-data" method='post'>

    <div class="info">
      <h1>숙소 기본 정보</h1>
      <div>
        <input class="basic-info" type="text" name="name" id="name" placeholder="숙소명">
      </div>
      <div>
        <textarea class="basic-info" name="explanation" id="explanation"
                  placeholder="숙소 설명"></textarea>
      </div>
      <div>
        <textarea class="basic-info" name="rentalHomeRule" id="rentalHomeRule"
                  placeholder="숙소 이용규칙"></textarea>
      </div>
    </div>

    <div class="info">
      <h1>숙소 위치</h1>
      <section>
        <div id="map"></div>
      </section>

      <input type="hidden" name="lat" id="lat">
      <input type="hidden" name="lon" id="lon">
      <div>
        <input class="location-info" type="text"  name="basicAddress" id="basicAddress"
               placeholder="기본 주소">
      </div>
      <div>
        <input class="location-info" type="text"  name="detailAddress" id="detailAddress"
               placeholder="상세 주소">
      </div>
    </div>

    <div class="photo-section">
    <h1>숙소 사진</h1>
      <h4>5장 이상의 사진을 선택해주세요.</h4>
      <label class="input-file-button" for="photoInput">사진 추가</label>
      <input type="file" multiple id="photoInput" name="photos" style="display:none;"
             onchange="photoCountAndDisplay(this.files)"/>
      <div id="imageContainer"></div>
    </div>

    <div class="info">
      <h1>요금설정</h1>
      <script>
        function calc() {
          const price = Number(document.getElementById("price").value);
          const cleanFee = Number(document.getElementById("cleanFee").value)
          document.getElementById("income").value = Math.round((price + cleanFee) * 0.97)
        }
      </script>
      <div>
        <input class="price-info" type="number" name="price" id="price" placeholder="이용요금(주 기준)"
               onkeyup="calc(this.value)">
      </div>
      <div>
        <input class="price-info" type="number" name="cleanFee" id="cleanFee" placeholder="청소비"
               onkeyup="calc(this.value)">
      </div>
      <div>
        <input class="price-info" readonly type="text" id="income" placeholder="정산금액">
      </div>
    </div>

    <div class="info">
      <h1>호스팅 기간</h1>
      <div class="duration-container">
        <div class="duration-item">
          <label for="hostingStartDate">호스팅 시작일:</label>
          <input class="hostingDate" name='hostingStartDate' id="hostingStartDate" type='date'>
        </div>
        <div class="duration-item">
          <label for="hostingEndDate">호스팅 종료일:</label>
          <input class="hostingDate" name='hostingEndDate' id="hostingEndDate" type='date'>
        </div>
      </div>
    </div>
  </form>

  <div>
    <button id="nextButton" type="submit" onclick="submitForm()">다음</button>
  </div>

  <br>
  <br>
</div>


<div data-th-replace="footer :: footer">꼬리말</div>
<script>
  var filesArray = []; // 이미지 배열
  var formData = new FormData(); // 폼데이터

  function checkRequiredFields() {
  // 필수 입력 필드 목록
  let requiredFields = [
    document.getElementById('name'),
    document.getElementById('explanation'),
    document.getElementById('rentalHomeRule'),
    document.getElementById('basicAddress'),
    document.getElementById('detailAddress'),
    document.getElementById('price'),
    document.getElementById('cleanFee'),
    document.getElementById('hostingStartDate'),
    document.getElementById('hostingEndDate')
  ];

  // 필수 입력 필드가 비어 있는지 확인
  let isEmpty = requiredFields.some(field => !field.value.trim());
  console.log(filesArray);

  let isDescriptionEmpty = filesArray.some(file => !file.description.value.trim());

  // 다음 버튼 가져오기
  const nextButton = document.querySelector('#nextButton');

  // 필수 입력 필드가 비어 있으면 다음 버튼을 비활성화
  if (isEmpty || filesArray.length < 5 || isDescriptionEmpty) {
    nextButton.disabled = true;
    nextButton.style.backgroundColor = '#CCCCCC';
  } else {
    nextButton.disabled = false;
    nextButton.style.backgroundColor = '#35C5B3'; // 활성화된 배경색
  }
}

// 페이지 로드 시, 입력 필드가 변경될 때마다 확인
window.onload = function() {
  // 입력 필드가 변경될 때마다 확인
  document.querySelectorAll('input, textarea').forEach(element => {
    element.addEventListener('input', checkRequiredFields);
  });


  // 초기에도 확인
  checkRequiredFields();
};

  function submitForm() {
    formData.append('name', document.querySelector('#name').value);
    formData.append('explanation', document.querySelector('#explanation').value);
    formData.append('rentalHomeRule', document.querySelector('#rentalHomeRule').value);

    let basicAddress = document.querySelector('#basicAddress').value;
    let detailAddress = document.querySelector('#detailAddress').value;

    formData.append('address', basicAddress + ". " + detailAddress);
    formData.append('lat', document.querySelector('#lat').value);
    formData.append('lon', document.querySelector('#lon').value);

    formData.append('price', document.querySelector('#price').value);
    formData.append('cleanFee', document.querySelector('#cleanFee').value);
    formData.append('hostingStartDate', document.querySelector('#hostingStartDate').value);
    formData.append('hostingEndDate', document.querySelector('#hostingEndDate').value);

    updateFormData(); // FormData 업데이트

    console.log(formData.getAll('photoExplanations'));
    console.log(formData.getAll('photos'));

    fetch('rentalHomeSave', {
      method: 'POST',
      body: formData

    }).then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.text();

    }).then(data => {
      console.log('Response data:', data);
      window.location.href = "themeForm"; // 자동으로 리디렉션

    }).catch(error => {
      console.error('Error:', error);
    });
  }

  // FormData 업데이트 함수
  function updateFormData() {
    filesArray.forEach(obj => {
      formData.append('photos', obj.file);
      formData.append('photoExplanations', obj.description.value);
    });
  }

  function photoCountAndDisplay(files) {
    var imageContainer = document.getElementById('imageContainer');

    for (var i = 0; i < files.length; i++) {
      let file = files[i];
      var reader = new FileReader();

      reader.onload = function (e) {
        var container = document.createElement('div');
        container.classList.add('image-container');

        var imgElement = document.createElement('img');
        imgElement.classList.add('image-item');
        imgElement.src = e.target.result;
        container.appendChild(imgElement);

        var descriptionInput = document.createElement('input');
        descriptionInput.type = 'text';
        descriptionInput.placeholder = '이미지 설명';
        descriptionInput.classList.add('image-description');
        descriptionInput.name = 'photoExplanations'; // 이미지 설명의 이름 설정
        container.appendChild(descriptionInput);

        var deleteButton = document.createElement('button');
        deleteButton.textContent = 'X';
        deleteButton.classList.add('delete-button');
        deleteButton.onclick = function () {
          var index = filesArray.findIndex(obj => obj.file === file);
          if (index > -1) {
            filesArray.splice(index, 1);
            checkRequiredFields();
            container.remove();

          }
        };
        container.appendChild(deleteButton);

        imageContainer.appendChild(container);

        // 파일과 설명을 하나의 객체로 연결하여 배열에 추가
        filesArray.push({
          file: file,
          description: descriptionInput
        });

        descriptionInput.addEventListener('input', checkRequiredFields);
        checkRequiredFields();
      };

      reader.readAsDataURL(file);
    }
  }
</script>

<script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCn7sXQ-7jFww0vK_pndKEMLEsJfMxAsmk&callback=initMap&v=weekly"
    defer>
</script>
<script>
  let map;
  let marker;
  let geocoder;
  let responseDiv;
  let response;
  let selectedLocation;
  let address;

  // google맵 생성
  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 10,
      center: { lat: 37.5518911, lng: 126.9917937 },
      mapTypeControl: false,
    });
    geocoder = new google.maps.Geocoder();

    // 맵 안쪽에 들어갈 html -- 검색 창 및 버튼
    const inputText = document.createElement("input");

    inputText.type = "text";
    inputText.placeholder = "주소";
    inputText.id = "mapInput";

    inputText.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
          geocode({ address: this.value });
        }
    });

    const submitButton = document.createElement("input");

    submitButton.type = "button";
    submitButton.value = "검색";
    submitButton.classList.add("button", "button-primary");

    const clearButton = document.createElement("input");

    clearButton.type = "button";
    clearButton.value = "초기화";
    clearButton.classList.add("button", "button-secondary");

    const selectButton = document.createElement("input");

    selectButton.type = "button";
    selectButton.value = "선택";
    selectButton.classList.add("button", "button-primary");
    selectButton.id = "select-button";

    response = document.createElement("pre");
    response.id = "response";
    response.innerText = "";
    responseDiv = document.createElement("div");
    responseDiv.id = "response-container";
    responseDiv.appendChild(response);


    map.controls[google.maps.ControlPosition.TOP_LEFT].push(inputText); // 주소 입력 박스
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(submitButton); // 주소 가져오기 버튼
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(clearButton); // 초기화 버튼
    map.controls[google.maps.ControlPosition.LEFT_TOP].push(responseDiv); // 주소 변환 결과값 출력 공간
    map.controls[google.maps.ControlPosition.RIGHT_TOP].push(selectButton);
    marker = new google.maps.Marker({
      map,
    });

    map.addListener("click", (e) => {
     geocode({ location: e.latLng });
    });

    submitButton.addEventListener("click", () =>
     geocode({ address: inputText.value })
    );

    clearButton.addEventListener("click", () => {
      clear();
    });

    selectButton.addEventListener("click", () => {
      let addressInput =  document.getElementById('basicAddress');
      let detailAddressInput = document.getElementById('detailAddress');
      let lat = document.getElementById("lat");
      let lon = document.getElementById('lon');

      addressInput.value = address;
      detailAddressInput.value = null;
      lat.value = selectedLocation.lat();
      lon.value = JSON.stringify(selectedLocation.lng());
    });

    clear();
  }

  // 초기화
  function clear() {
    marker.setMap(null);
    responseDiv.style.display = "none";
  }

  // 주소 변환
  function geocode(request) {
    clear();
    geocoder
      .geocode(request)
      .then((result) => {
        const { results } = result;

        map.setCenter(results[0].geometry.location);
        marker.setPosition(results[0].geometry.location);
        marker.setMap(map);
        responseDiv.style.display = "block";

        address = results[0].formatted_address;
        selectedLocation = results[0].geometry.location;
        response.innerText = JSON.stringify(results[0].formatted_address, null, 2);
        return results;
      })
      .catch((e) => {
        responseDiv.style.display = "block";
        response.innerText = "검색결과가 없습니다.";
      });
  }

  window.initMap = initMap;
</script>

</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

</html>