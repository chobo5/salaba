<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <link rel="stylesheet" type="text/css" href="/css/common.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>

    #main-container {
      width: 90%;
      margin-left: 60px;
    }

    #bar-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 20px 60px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #income-container {
      font-size: 23px;
      font-weight: bold;
      color: #555555;
      margin-left: 20px;
    }

    #totalIncome {
      margin-left: 10px;
      padding: 5px 10px;
      border-radius: 5px;
      background-color: #f8f9fa;
      color: #555555;

    }

    #search-container {
      text-align: right;
      margin: 20px 60px 20px 0px;;
      font-size: 12px;
      justify-content: center;
      align-items: center;
    }

    #startDate,
    #endDate {
      padding: 5px 8px;
      border-radius: 5px;
      cursor: pointer;
    }

    #searchButton {
      display: inline-block;
      padding: 6px 9px;
      font-size: 12px;
      cursor: pointer;
      text-align: center;
      margin-left: 10px;
      border: 2px solid #35C5B3; /* 테두리 색상 */
      color: #35C5B3; /* 텍스트 색상 */
      border-radius: 5px; /* 버튼 모서리 둥글게 */
    }

    #searchButton:hover {
      color: #fff; /* 호버 시 텍스트 색상 변경 */
      background-color: #35C5B3; /* 호버 시 배경 색상 변경 */
      transition: color 0.3s, background-color 0.3s;
    }

    .rentalHome-container {
      display: flex;
      box-shadow: 0 4px 6px rgba(0, 0.1, 0, 0.3);
      border-radius: 20px;
      margin: 15px 5px;
      position: relative;
      cursor: pointer;
      overflow: hidden;
      justify-content: center;
      align-items: center;
      background: linear-gradient(120deg, #fff, #f8f9fa);

    }

    .rentalHome-container:hover {
      background-color: #eaeaea;
      transform: scale(1.05);
      transition: background-color 0.3s, transform 0.3s;
    }



    .span-content {
      flex:1;
      max-width: 300px;
      word-wrap: break-word;
      text-align: center;
    }

    .detail-item {
      border: 1px solid black;
      margin: 10px;
      flex: 1;
    }

    span {
      padding: 10px;
    }

    .thumbnails {
      margin: 10px;
      border-radius: 20px;
    }
  </style>
</head>
<body>
<div data-th-replace="host/hostHeader :: hostHeader">머리말</div>

<div id="bar-container">
  <div id="income-container">
    전체 수입: <span id="totalIncome">0</span>
  </div>

  <div id="search-container">
    <input id='startDate' data-th-value="${showStartDate}" type='date'/>
    <span id="~">~</span>
    <input id='endDate' data-th-value="${showEndDate}" type='date'/>
    <a id="searchButton">조회</a>
  </div>
</div>

<div id="main-container">
  <div data-th-each="rentalHome : ${rentalHomeList}" data-th-object="${rentalHome}"
       class="rentalHome-container"
       data-th-data-price="*{price}" data-price="10000"
       data-th-data-no="*{rentalHomeNo}" data-no="1"
       data-th-data-cleanFee="*{cleanFee}" data-cleanFee="2000"
       data-toggle="modal" data-target="#detailModal">
    <img class="thumbnails"
         data-th-src="@{'https://5ns6sjke2756.edge.naverncp.com/nBMc0TCJiv/rentalHome/' + ${rentalHome.rentalHomePhotos[0].uuidPhotoName}(type=f,w=80,h=80,ttype=jpg)}"
         src="/photo1.jpg">
    <span class="span-content" data-th-text="*{name}">xxx</span>
    <span class="span-content" data-th-text="'등록일:' + *{registeDate}">2024-01-01</span>
    <span class="span-content address" data-th-text="'주소:' + *{address}">서울시 강남구...</span>
    <span class="span-content" data-th-id="'usageCount_' + *{rentalHomeNo}">0</span>
  </div>
</div>

<!-- 상세 정보 모달 -->
<div class="modal fade" id="detailModal" tabindex="-1" role="dialog" aria-labelledby="detailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailModalLabel">상세 정보</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="detailContainer"></div>
      </div>
    </div>
  </div>
</div>


<div data-th-replace="footer :: footer">꼬리말</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script data-th-inline="javascript">
  // 화면에 필요한 정보들 변수에 저장
  var reservationList = [[${reservationList}]];
  var rentalHomeList = document.querySelectorAll(".rentalHome-container");
  var filteredReservationList;

  // 날짜 조회 버튼
  var searchButton = document.getElementById("searchButton");
  searchButton.addEventListener('click', () => {
    let startDate = document.getElementById("startDate").value;
    let endDate = document.getElementById("endDate").value;

    // 예약내역 필터링
    filteredReservationList = reservationList.filter(function(reservation) {
      return reservation.paymentDate >= startDate && reservation.paymentDate <= endDate;
    });

    getDefaultReservation(filteredReservationList);
  })

  // 상세 보기 이벤트 설정
  rentalHomeList.forEach(el => {
    el.addEventListener('click', (e) => {
      let rentalHomeNo = e.currentTarget.getAttribute("data-no");
      if (filteredReservationList != null) {
        showDetail(rentalHomeNo, filteredReservationList);
      } else {
        showDetail(rentalHomeNo, reservationList);
      }
    })
  });

  // 이용건수, 총 수입 초기화하는 함수(기본, 전체)
  document.addEventListener('DOMContentLoaded', function() {
    getDefaultReservation(reservationList);
  });

  // 상세 보기 출력(모달 방식)
  function showDetail(rentalHomeNo, reservationList) {
    let rentalHomeEl = document.querySelector(`.rentalHome-container[data-no="${rentalHomeNo}"]`);
    let no = rentalHomeEl.getAttribute("data-no");

    let cleanFee = rentalHomeEl.getAttribute("data-cleanFee");
    let rentalHomeReservationList = [];

    // 숙소별 예약내역 리스트 받기
    reservationList.forEach(function(reservation) {
      if (reservation.rentalHomeNo == no) {
        rentalHomeReservationList.push(reservation);
      }
    });

    let detailContainer = document.getElementById("detailContainer");
    detailContainer.innerHTML = ""; // 기존 내용 초기화

    if (rentalHomeReservationList.length != 0) {
      rentalHomeReservationList.forEach(function(reservationEl) {
        let detailItem = `
          <div class="detail-item">
            <div class="title-div">
              <span>${reservationEl.reservationNo}</span>
              <span>${reservationEl.paymentDate}</span>
            </div>
            <div class="name-div">
              <span>결제금액</span>
              <span>이용 기간</span>
              <span>청소비</span>
              <span>수수료</span>
              <span>정산금액</span>
              <span>게스트</span>
            </div>
            <div class="value-div">
              <span>${reservationEl.amount}</span>
              <span>${reservationEl.startDate} ~ ${reservationEl.endDate}</span>
              <span>${cleanFee}원</span>
              <span>${reservationEl.amount * 0.03}</span>
              <span>${reservationEl.amount - cleanFee - (reservationEl.amount * 0.03)}</span>
              <span>${reservationEl.guestName}</span>
            </div>
          </div>
        `;
        detailContainer.innerHTML += detailItem;
      });
    } else {
      detailContainer.innerHTML = "<p>해당 기간 내 예약 내역이 없습니다.</p>";
    }
  }

  // 기본 예약 내역 출력 및 총 수입 계산
  function getDefaultReservation(reservationList) {
    let totalIncome = 0;

    rentalHomeList.forEach(el => {
      let no = el.getAttribute("data-no");
      let cleanFee = el.getAttribute("data-cleanFee");
      let usageCount = 0;

      reservationList.forEach(function(reservation) {
        if (reservation.rentalHomeNo == no) {
          usageCount++;
          totalIncome += reservation.amount - cleanFee - (reservation.amount * 0.03);
        }
      });

      document.getElementById("usageCount_" + no).textContent = usageCount;
    });

    document.getElementById("totalIncome").textContent = totalIncome;
  }
</script>
</body>
</html>