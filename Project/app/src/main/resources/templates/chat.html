<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset="UTF-8">
  <title>chat</title>
</head>
<body>
<div id="messageContainer"></div>
<input type="text" id="messageInput" placeholder="메시지 입력" onkeyup="enter(event)">
<button onclick="enter(event)">Send</button>

<a type="button" data-th-href="@{host/chatList(hostNo=${session.loginUser.no})}">나가기</a>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  function enter(event) {
    if (event.keyCode === 13) {
      sendMessage();
    }
  }

  const ws = new WebSocket('ws://localhost:8889');

  // URL에서 쿼리 매개변수를 가져오는 함수
  function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, '\\$&');
    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
      results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
  }

  // sender 설정
  var sender = getParameterByName('sender');
  if(sender == 1){
    sender = 'guest';
  }else{
    sender = 'host';
  }
  console.log(sender);

  // 예약번호 설정(방 식별자)
  const reservationNo = getParameterByName('reservationNo');

  // 회원정보 설정
  const memberName = getParameterByName('name');
  const memberNo = getParameterByName('memberNo');

  if(sender == 1){
    sender = 'guest';
  }else{
    sender = 'host';
  }
  console.log(sender);

  const requestData = {
    message:'getChat',
    memberNo: memberNo,
    reservationNo : reservationNo,
    chatName: `chat-${reservationNo}.json`,
    sender: sender
  }

  ws.onopen = function(event){
    console.log(requestData);
    ws.send(JSON.stringify(requestData));
  }

  ws.onmessage = function(event){
    const message = JSON.parse(event.data);
    console.log(message);
    const messageContainer = document.getElementById('messageContainer');
    message.forEach((element) => {
      let messageElement = document.createElement('div');
      let messageContent = document.createElement('span');
      messageContent.textContent = element.content;
      messageElement.appendChild(messageContent);
      messageContainer.appendChild(messageElement);
    });
  };

  function sendMessage(){
    const messageInput = document.getElementById('messageInput');
    const message = {
      memberNo: memberNo,
      name: memberName,
      sender: sender,
      timestamp: new Date().toISOString(),
      content: messageInput.value,
      chatName:`chat-${reservationNo}.json`,
      reservationNo: reservationNo
    };

    console.log("메시지 전송 전" + message);

    ws.send(JSON.stringify(message));
    messageInput.value = '';
  }

</script>
</body>