<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset="UTF-8">
  <title>chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    #messageContainer {
      display: flex;
      flex-direction: column;
      max-height: 400px;
      overflow-y: auto;
      padding: 10px;
    }

    /* 메시지 박스 크기 및 배경색 조정 */
    .messageBox {
      position: relative;
      border-radius: 20px;
      padding: 7px 12px;
      margin: 20px;
      max-width: 30%; /* 최대 너비를 설정하여 너비를 넘어가면 자동으로 줄바꿈되도록 설정 */
      word-wrap: break-word; /* 너무 긴 텍스트는 줄바꿈되도록 설정 */
    }

    .messageBox.me {
      background-color: #35C5B3;
      text-align: right;
      align-self: flex-end; /* 오른쪽 정렬 */
      margin-left: auto; /* 왼쪽 여백을 설정하여 오른쪽 정렬 요소와의 간격을 유지 */
    }

    .messageBox.notMe {
      background-color: #E0F2F1;
      text-align: left;
      align-self: flex-start; /* 왼쪽 정렬 */
      margin-right: auto; /* 오른쪽 여백을 설정하여 왼쪽 정렬 요소와의 간격을 유지 */
    }

    .messageSender.me {
      position: absolute;
      top: -25px;
      font-weight: bold;
      font-size: 15px;
    }

    .messageSender.notMe {
      position: absolute;
      top: -25px;
      font-weight: bold;
      font-size: 15px;
    }

    .messageContent {
      margin-top: 5px;
    }

    #messageInput {
      width: calc(100% - 70px);
      padding: 10px;
      border-radius: 5px 0 0 5px;
      border: 1px solid #ccc;
      outline: none;
    }

    #sendButton {
      width: 70px;
      padding: 10px;
      border: none;
      border-radius: 0 5px 5px 0;
      background-color: #35C5B3;
      color: white;
      cursor: pointer;
    }

    #sendButton:hover {
      background-color: #1C9189;
    }

    #messageInputContainer {
      display: flex;
      margin-bottom: 10px;
    }

    a {
      margin-top: 20px;
      color: #35C5B3;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .sendTime.me {
      position: absolute;
      left: -72px;
      top: 15px;
      color: #171717;
    }

    .sendTime.notMe {
      position: absolute;
      right: -72px; /* 오른쪽에 위치하도록 수정 */
      top: 15px;
      color: #171717;
    }

  </style>
</head>
<body>
<div data-th-replace="host/hostHeader :: hostHeader">머리말</div>
<div id="messageContainer"></div>
<input type="text" id="messageInput" placeholder="메시지 입력" onkeyup="enter(event)">
<button id="send-button">Send</button>

<a type="button" data-th-href="@{host/chatList(hostNo=${session.loginUser.no})}">나가기</a>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  function enter(event) {
    if (event.keyCode === 13) {
      sendMessage();
    }
  }

  document.querySelector('#send-button').onclick = () => {
    sendMessage();
  }

  const ws = new WebSocket('ws://localhost:8889');

  // URL에서 쿼리 매개변수를 가져오는 함수
  function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, '\\$&');
    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
      results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
  }

  // sender 설정
  var sender = getParameterByName('sender');
  if(sender == 1){
    sender = 'guest';
  }else{
    sender = 'host';
  }
  console.log(sender);

  // 예약번호 설정(방 식별자)
  const reservationNo = getParameterByName('reservationNo');

  // 회원정보 설정
  const memberName = getParameterByName('name');
  const memberNo = getParameterByName('memberNo');

  if(sender == 1){
    sender = 'guest';
  }else{
    sender = 'host';
  }
  console.log(sender);

  const requestData = {
    message:'getChat',
    memberNo: memberNo,
    reservationNo : reservationNo,
    chatName: `chat-${reservationNo}.json`,
    sender: sender
  }

  ws.onopen = function(event){
    console.log(requestData);
    ws.send(JSON.stringify(requestData));
  }

  ws.onmessage = function(event){
    const message = JSON.parse(event.data);
    console.log("받은 메시지");
    console.log(message);
    const messageContainer = document.getElementById('messageContainer');
    message.forEach((element) => {
    if (element.content != "") {
      let messageElement = document.createElement('div');
      let messageSender = document.createElement('div');
      let messageContent = document.createElement('span');
      let sendTime = document.createElement('span');

      messageSender.className="messageSender"
      messageContent.className="messageContent";
      messageElement.className="messageBox";
      sendTime.className="sendTime";


      messageContent.textContent = element.content;
      messageSender.textContent = element.name;
      sendTime.textContent = element.timestamp;


      messageElement.appendChild(messageSender);
      messageElement.appendChild(messageContent);
      messageElement.appendChild(sendTime);

      // sender가 memberName과 일치하는지 확인
      if (element.name === memberName) {
        messageElement.classList.add('me');
        messageSender.classList.add('me');
        sendTime.classList.add('me');
      } else {
        messageElement.classList.add('notMe');
        messageSender.classList.add('notMe');
        sendTime.classList.add('notMe');
      }

      messageContainer.appendChild(messageElement);
      }
    });
  };

  function sendMessage(){
    const messageInput = document.getElementById('messageInput');
    const message = {
      memberNo: memberNo,
      name: memberName,
      sender: sender,
      timestamp: new Date(),
      content: messageInput.value,
      chatName:`chat-${reservationNo}.json`,
      reservationNo: reservationNo
    };

    console.log("메시지 전송 전" + message);

    ws.send(JSON.stringify(message));
    messageInput.value = '';
  }


</script>
</body>
