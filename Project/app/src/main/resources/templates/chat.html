<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset="UTF-8">
  <title>chat</title>
</head>
<body>
  <div id="messageContainer"></div>
  <input type="text" id="messageInput" placeholder="메시지 입력">
  <button onclick="sendMessage()">Send</button>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    const ws = new WebSocket('ws://localhost:8889');

    // URL에서 쿼리 매개변수를 가져오는 함수
    function getParameterByName(name, url) {
      if (!url) url = window.location.href;
      name = name.replace(/[\[\]]/g, '\\$&');
      var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
        results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    // sender설정
    var sender = getParameterByName('sender');
    if(sender == 1){
      sender = 'guest';
    }else{
      sender = 'host';
    }
    console.log(sender);    
        
    const requestData = {
      message:'getChat',
      reservationNo : 1,
      chatName: 'chat.json',
      sender: sender
    }

    ws.onopen = function(event){
      console.log(requestData);
      ws.send(JSON.stringify(requestData));
    }

    ws.onmessage = function(event){
      console.log(event.data);
      const message = JSON.parse(event.data);
      console.log(message);
      const messageContainer = document.getElementById('messageContainer');
      message.forEach((element) => {
        let messageElement = document.createElement('div');
        let messageContent = document.createElement('span');
        messageContent.textContent = element.content;
        messageElement.appendChild(messageContent);
        messageContainer.appendChild(messageElement);
      });
    };

    function sendMessage(){
      const messageInput = document.getElementById('messageInput');
      const message = {
        name: '11',
        sender: sender,
        timestamp: new Date().toISOString(),
        content: messageInput.value,
        chatName:'chat.json'
      };

      ws.send(JSON.stringify(message));
      messageInput.value = '';
    }

    window.addEventListener('beforeunload', function(event){
      const message = {
        message: 'close',
        memberNo: memberNo,
        reservationNo: reservationNo
      }
      ws.send(JSON.stringify(message));
    });

  </script>
</body>