<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset="UTF-8">
  <title>chat</title>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <link rel="stylesheet" type="text/css" href="/css/common.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    #mainContainer {
      position: relative;
    }

    #messageContainer {
      display: flex;
      flex-direction: column;
      max-height: 540px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #CCCCCC;
      border-radius: 5px;
      margin: 10px 10px 0px 10px;
      min-height: 540px;
    }

    /* 메시지 박스 크기 및 배경색 조정 */
    .messageBox {
      position: relative;
      border-radius: 20px;
      padding: 7px 12px;
      margin: 20px;
      max-width: 30%; /* 최대 너비를 설정하여 너비를 넘어가면 자동으로 줄바꿈되도록 설정 */
      word-wrap: break-word; /* 너무 긴 텍스트는 줄바꿈되도록 설정 */
    }

    .messageBox.me {
      background-color: #35C5B3;
      text-align: right;
      align-self: flex-end; /* 오른쪽 정렬 */
      margin-left: auto; /* 왼쪽 여백을 설정하여 오른쪽 정렬 요소와의 간격을 유지 */
    }

    .messageBox.notMe {
      background-color: #E0F2F1;
      text-align: left;
      align-self: flex-start; /* 왼쪽 정렬 */
      margin-right: auto; /* 오른쪽 여백을 설정하여 왼쪽 정렬 요소와의 간격을 유지 */
    }

    .messageSender.me {
      position: absolute;
      top: -25px;
      right: 6px;
      font-weight: bold;
      font-size: 15px;
    }

    .messageSender.notMe {
      position: absolute;
      top: -25px;
      left: 6px;
      font-weight: bold;
      font-size: 15px;
    }

    .messageContent {
      margin-top: 5px;
    }

    #messageInput {
      position: relative;
      width: calc(100% - 40px); /* sendButton의 너비(패딩 10px * 2 + border 1px * 2)만큼 뺀다 */
      margin: 0px 10px 10px 10px;
      bottom: 10px;
      height: 60px;
      padding: 10px;
      border-radius: 5px 5px 5px 5px;
      border: 1px solid #ccc;
      outline: none;
      font-size: 16px;
    }

    #sendButton {
      position: absolute;
      font-size: 25px;
      right: 27px;
      bottom: 37.5px;
      padding: 10px;
      border: 1px solid #CCCCCC;
      border-radius: 20px;
      background-color: #35C5B3;
      color: white;
      cursor: pointer;
    }

    #sendButton:hover {
      background-color: #1C9189;
    }

    #exitButton {
      position: absolute;
      top: 0;
      left: 10px;
      font-size: 14px;
      padding: 5px 8px;
      border: 1px solid #CCCCCC;
      border-radius: 5px;
      background-color: #FA5858;
      color: white;
      cursor: pointer;
      z-index: 1;
    }

    #exitButton:hover {
      background-color: #;
    }

    a {
      margin-top: 20px;
      color: #35C5B3;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .sendTime.me {
      position: absolute;
      left: -75px;
      bottom: 1px;
      color: #171717;
    }

    .sendTime.notMe {
      position: absolute;
      right: -75px;
      bottom: 1px;
      color: #171717;
    }

    .dateMessage {
      display: block;
      background: #CCCCCC;
      border-radius: 4px;
      text-align: center;
      margin: 15px;
      padding: 3px;
    }


  </style>
</head>
<body>
<div data-th-replace="host/hostHeader :: hostHeader">머리말</div>


<div id="mainContainer">
  <i id="exitButton" class="fa-solid fa-chevron-left"></i>
  <div id="messageContainer"></div>
  <div id="messageInputContainer" style="position: relative;">
    <input type="text" id="messageInput" placeholder="메시지 입력" onkeyup="enter(event)">
    <div id="sendButtonContainer">
      <i id="sendButton" class="fa-solid fa-location-arrow"></i>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script data-th-inline="javascript">
  document.getElementById('exitButton').onclick = () => {
    let memberNo = [[${session.loginUser.no}]]
    window.location.href="/host/chatList?hostNo=" + memberNo;
  };

  function enter(event) {
    if (event.keyCode === 13) {
      sendMessage();
    }
  }

  document.querySelector('#sendButton').onclick = () => {
    sendMessage();
  }

  const ws = new WebSocket('ws://localhost:8889');

  // URL에서 쿼리 매개변수를 가져오는 함수
  function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, '\\$&');
    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
      results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
  }

  // sender 설정
  var sender = getParameterByName('sender');
  if(sender == 1){
    sender = 'guest';
  }else{
    sender = 'host';
  }

  // 예약번호 설정(방 식별자)
  const reservationNo = getParameterByName('reservationNo');

  // 회원정보 설정
  const memberName = getParameterByName('name');
  const memberNo = getParameterByName('memberNo');

  if(sender == 1){
    sender = 'guest';
  }else{
    sender = 'host';
  }

  const requestData = {
    message:'getChat',
    memberNo: memberNo,
    reservationNo : reservationNo,
    chatName: `chat-${reservationNo}.json`,
    sender: sender
  }

  ws.onopen = function(event){
    ws.send(JSON.stringify(requestData));
  }

  var lastDate;

  ws.onmessage = function(event){
    const message = JSON.parse(event.data);
    console.log("받은 메시지");
    console.log(message);
    const messageContainer = document.getElementById('messageContainer');

    message.forEach((element) => {
      if (element.content != "") {
        let messageElement = document.createElement('div');
        let messageSender = document.createElement('div');
        let messageContent = document.createElement('span');
        let sendTime = document.createElement('span');

        // 이전 날짜와 다르면 변경된 날짜 출력
        let newDate = checkAndUpdateDate(element.timestamp);

        // 이전에 저장된 날짜와 현재 날짜가 다른 경우에만 출력
        if (newDate !== lastDate) {
          console.log("날짜 출력")
          let dateMessage = document.createElement('div');
          dateMessage.className= "dateMessage";
          dateMessage.textContent = newDate;

          messageContainer.appendChild(dateMessage);
          lastDate = newDate;
        }

        // 날짜 변환(오전 00:00)
        element.timestamp = formatTime(element.timestamp);

        messageSender.className="messageSender"
        messageContent.className="messageContent";
        messageElement.className="messageBox";
        sendTime.className="sendTime";


        messageContent.textContent = element.content;
        messageSender.textContent = element.name;
        sendTime.textContent = element.timestamp;


        messageElement.appendChild(messageSender);
        messageElement.appendChild(messageContent);
        messageElement.appendChild(sendTime);

        // sender가 memberName과 일치하는지 확인
        if (element.name === memberName) {
          messageElement.classList.add('me');
          messageSender.classList.add('me');
          sendTime.classList.add('me');
        } else {
          messageElement.classList.add('notMe');
          messageSender.classList.add('notMe');
          sendTime.classList.add('notMe');
        }

        messageContainer.appendChild(messageElement);
      }
    });
  }
  function sendMessage(){
    const messageInput = document.getElementById('messageInput');
    const message = {
      memberNo: memberNo,
      name: memberName,
      sender: sender,
      timestamp: new Date(),
      content: messageInput.value,
      chatName:`chat-${reservationNo}.json`,
      reservationNo: reservationNo
    };

    ws.send(JSON.stringify(message));
    messageInput.value = '';
  }

  // 시간 포맷팅 함수
function formatTime(timestamp) {
  const currentTime = new Date(timestamp);
  let hours = currentTime.getHours();
  let minutes = currentTime.getMinutes();

  // 시간을 오전 또는 오후로 변환
  const ampm = hours >= 12 ? '오후' : '오전';

  hours = hours % 12;
  hours = hours ? hours : 12; // 0시를 12시로 표시

  minutes = minutes < 10 ? '0' + minutes : minutes;

  return `${ampm} ${hours}:${minutes}`;
}

function checkAndUpdateDate(timestamp) {
  console.log("왜 안나옴?");
  const newDate = new Date(timestamp);
  const year = newDate.getFullYear();
  const month = newDate.getMonth() + 1;
  const day = newDate.getDate();
  const formattedDate = `${year}년 ${month < 10 ? '0' + month : month}월 ${day < 10 ? '0' + day : day}일`;

  return formattedDate;
}

</script>
<script data-th-src="@{/js/header.js}"></script>
</body>
