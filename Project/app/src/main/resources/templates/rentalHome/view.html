<!DOCTYPE html>
<html lang="en" xmlns:data-th="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Title</title>
  <script th:inline="javascript">
    const rentalHomeModel = /*[[${rentalHome}]]*/ null;
    const sessionMemberNo = /*[[${session.memberNo}]]*/ null;
    const rentalHomeNoModel = /*[[${rentalHome.rentalHomeNo}]]*/ null;
    const rentalHomeReviewModel = /*[[${rentalHomeReview}]]*/ null;
  </script>
  <script>
    (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
      key: "AIzaSyCn7sXQ-7jFww0vK_pndKEMLEsJfMxAsmk",
      // Add other bootstrap parameters as needed, using camel case.
      // Use the 'v' parameter to indicate the version to load (alpha, beta, weekly, etc.)
    });
  </script>
  <style>
    #map{
      height: 500px;
      width: 100%;
    }
  </style>
</head>
<body>
<main>
  <section>
    <div class="search-container">
      <h1>어디로 여행 가시나요?</h1>
      <form action="/rentalHome/search" data-th-action="@{search}" id="condition-search" method="get">
        <input type="text" name="regionName" id="location" placeholder="장소 입력">
        <input type="date" name="checkInDate" id="check-in" placeholder="체크인 날짜">
        <input type="date" name="checkOutDate" id="check-out" placeholder="체크아웃 날짜">
        <input type="number" name="capacity" id="guests" placeholder="인원">
        <button type="submit">검색</button>
      </form>
    </div>
  </section>
  <section>
    <h1 data-th-text="${rentalHome.name}">숙소 이름</h1>
    <button id="reportButton">신고하기</button>

    <div id="reportModal" style="display: none;">
      <h2>숙소 신고</h2>
      <form id="reportForm">
        <select id="category">
          <option value="1">부정확하거나 틀린 정보가 있어요</option>
          <option value="2">실제 숙소가 아닙니다</option>
          <option value="3">사기입니다</option>
          <option value="4">불쾌합니다</option>
          <option value="5">기타</option>
        </select>
        <br>
        <input type="text" id="content" placeholder="신고 사유를 입력하세요">
        <br>
        <button type="submit">신고하기</button>
        <button type="button" id="cancelButton">취소</button>
      </form>
    </div>

    <h2 data-th-text="${rentalHome.explanation}">숙소 소개</h2>
    <div data-th-each="photo : ${rentalHomePhoto}" data-th-object="${rentalHomePhoto}">
      <img data-th-src=" @{'https://kr.object.ncloudstorage.com/tp3-salaba/rental_home/' + ${photo.uuidPhotoName}}" alt="숙소 이미지">
    </div>
    <h3 data-th-text="${rentalHome.address}">숙소 주소</h3>
    <h3 data-th-text="${rentalHome.price}">가격</h3>
    <div data-th-each="facility : ${rentalHomeFacility}" data-th-object="${rentalHomeFacility}">
      <h6 data-th-text="${facility.facilityName}">시설 이름</h6>
      <h6 data-th-text="${facility.facilityCount}">시설 갯수</h6>
    </div>
  </section>
  <section>
    <div id="map">

    </div>
  </section>
  <section>
    <div id="reviewsContainer">
      <h3>숙소 리뷰</h3>
    </div>
    <button id="showMoreReview">리뷰 더 보기</button>
  </section>
  <section>
    <div>
      <h3 data-th-text="${rentalHome.cleanFee}">청소비</h3>
      <h3 data-th-text="${rentalHome.rentalHomeRule}">숙소 규칙</h3>
    </div>
  </section>
</main>
<link rel="stylesheet" th:href="@{/mainStyle.css}" />

<script>
  const reportModal = document.getElementById("reportModal");
  const reportButton = document.getElementById("reportButton");
  const cancelButton = document.getElementById("cancelButton");

  // 신고 버튼 클릭 시
  reportButton.addEventListener("click",()=>{
    reportModal.style.display = "block";
  });

  // 취소 버튼 클릭 시
  cancelButton.addEventListener("click", ()=>{
    reportModal.style.display = "none";
  });

  // 외부 클릭시 닫기
  window.addEventListener("click",(event)=>{
    if( event.target == reportModal ){
      reportModal.style.display = "none";
    }
  });

  // form 제출 시 데이터 전송 AJAX 사용
  document.getElementById("reportForm").addEventListener("submit",(event)=>{
    event.preventDefault(); // 기본 동작 취소

    const category = document.getElementById("category").value;
    const content = document.getElementById("content").value;
    const memberNo = sessionMemberNo;
    const rentalHomeNo = rentalHomeNoModel;

    // RentalHomeReport 객체 생성
    const rentalHomeReport = {
      rentalHomeNo: rentalHomeNo,
      memberNo: memberNo,
      content: content,
      reportCategoryNo: category
    }

    // Ajax 요청 보내기
    const xhr = new XMLHttpRequest();
    xhr.open( "POST", "/rentalHome/report", true );
    xhr.setRequestHeader( "Content-type", "application/json" );
    xhr.onreadystatechange = () => {
      if( xhr.readyState === XMLHttpRequest.DONE ){
        if( xhr.status === 200 ){
          alert("신고가 접수되었습니다.");
          // 신고 닫기
          reportModal.style.display = "none";
        }else{
          alert("오류가 발생했습니다. 다시 시도해주세요.");
        }
      }
    };
    xhr.send(JSON.stringify(rentalHomeReport));
  });

  let startIndex = 0;
const batchSize = 5;
let rentalHomeReviews = rentalHomeReviewModel;

function showNextBatchOfReview() {
  const reviewsContainer = document.getElementById('reviewsContainer');
  const endIndex = Math.min(startIndex + batchSize, rentalHomeReviews.length);
  for (let i = startIndex; i < endIndex; i++) {
    const review = rentalHomeReviews[i];
    const reviewElement = document.createElement('div');
    reviewElement.innerHTML = '<div>' +
      '<h4>평점</h4>' +
      '<p>' + review.review + '</p>' + // 리뷰 내용
      '<p>' + review.createdDate + '</p>' + // 작성일시
      '</div>';
    reviewsContainer.appendChild(reviewElement);
  }
  startIndex = endIndex;
  if (startIndex >= rentalHomeReviews.length) {
    document.getElementById('showMoreReview').style.display = 'none';
  }
}

// 리뷰 더 보기 버튼 클릭 시
document.getElementById('showMoreReview').addEventListener('click', function() {
  showNextBatchOfReview();
});

// 초기에 최초의 2개 리뷰 표시
window.addEventListener('DOMContentLoaded', function() {
  const reviewsContainer = document.getElementById('reviewsContainer');
  for (let i = 0; i < Math.min(2, rentalHomeReviews.length); i++) {
    const review = rentalHomeReviews[i];
    const reviewElement = document.createElement('div');
    reviewElement.innerHTML = '<div>' +
      '<h4>평점</h4>' +
      '<p>' + review.review + '</p>' + // 리뷰 내용
      '<p>' + review.createdDate + '</p>' + // 작성일시
      '</div>';
    reviewsContainer.appendChild(reviewElement);
  }
  startIndex = 2;
  if (rentalHomeReviews.length <= 2) {
    document.getElementById('showMoreReview').style.display = 'none'; // 버튼 숨기기
  }
});

async function initMap(){
  const rentalHome = rentalHomeModel;
  const position = { lat:Number(rentalHome.lat) , lng:Number(rentalHome.lon) };
  
  console.log( typeof rentalHome.lat );
  console.log( typeof rentalHome.lon );
  
  const{ Map } = await google.maps.importLibrary("maps");
  const{ AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker");
  
  let map = new Map(document.getElementById("map"), {
    zoom : 16,
    center: position,
    mapId: '470e45162ba863f'
  });
  
  const marker = new google.maps.marker.AdvancedMarkerElement({
    map: map,
    position: position,
  });
}

initMap();

</script>

</body>
</html>
