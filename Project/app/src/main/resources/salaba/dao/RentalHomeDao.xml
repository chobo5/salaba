<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="salaba.dao.RentalHomeDao">

  <resultMap id="RentalHomeMap" type="RentalHome">
    <id column="rental_home_no" property="rentalHomeNo"/>
    <result column="name" property="name"/>
    <result column="price" property="price"/>
    <result column="explanation" property="explanation"/>
    <result column="address" property="address"/>
    <result column="capacity" property="capacity" javaType="int"/>
    <result column="lat" property="lat"/>
    <result column="lon" property="lon"/>
    <result column="hosting_start_date" property="hostingStartDate"/>
    <result column="hosting_end_date" property="hostingEndDate"/>
    <result column="registe_date" property="registeDate"/>
    <result column="clean_fee" property="cleanFee"/>
    <result column="state" property="state"/>
    <result column="rental_home_rule" property="rentalHomeRule"/>
    <result column="like_count" property="rentalHomeLikeCount"/>

    <association property="region" resultMap="region"/>
    <collection property="rentalHomePhotos" resultMap="rentalHomePhotos" javaType="java.util.List"/>
    <collection property="themes" resultMap="themeMap" javaType="java.util.List"/>
  </resultMap>

  <resultMap id="rentalHomeFacilityMap" type="RentalHomeFacility">
    <id column="facility_no" property="facilityNo"/>
    <result column="facility_name" property="facilityName"/>
    <result column="facility_count" property="facilityCount"/>
  </resultMap>

  <resultMap id="rentalHomePhotos" type="RentalHomePhoto">
    <id column="photo_no" property="photoNo"/>
    <result column="ori_photo_name" property="oriPhotoName"/>
    <result column="uuid_photo_name" property="uuidPhotoName"/>
    <result column="photo_explanation" property="photoExplanation"/>
    <result column="photo_order" property="photoOrder"/>
  </resultMap>

  <resultMap id="region" type="Region">
    <id column="region_no" property="regionNo"/>
    <result column="region_name" property="regionName"/>
  </resultMap>

  <resultMap id="themeMap" type="Theme">
    <id column="theme_no" property="themeNo"/>
    <result column="theme_name" property="themeName"/>
  </resultMap>

  <resultMap id="rentalHomeReview" type="RentalHomeReview">
    <id column="reservation_no" property="reservationNo"/>
    <result column="created_date" property="createdDate"/>
    <result column="score" property="score"/>
    <result column="review" property="review"/>
  </resultMap>

  <resultMap id="rentalHomeSearch" type="RentalHome">
    <id column="rental_home_no" property="rentalHomeNo"/>
    <result column="name" property="name"/>
    <result column="price" property="price"/>
    <result column="like_count" property="rentalHomeLikeCount"/>
    <result column="lat" property="lat"/>
    <result column="lon" property="lon"/>

    <collection property="rentalHomePhotos" resultMap="rentalHomePhotos"/>
  </resultMap>

  <resultMap id="rentalHomeView" type="RentalHome">
    <id column="rental_home_no" property="rentalHomeNo"/>
    <result column="name" property="name"/>
    <result column="price" property="price"/>
    <result column="explanation" property="explanation"/>
    <result column="capacity" property="capacity"/>
    <result column="lat" property="lat"/>
    <result column="lon" property="lon"/>
    <result column="state" property="state"/>
    <result column="hosting_start_date" property="hostingStartDate"/>
    <result column="hosting_end_date" property="hostingEndDate"/>
    <result column="registe_date" property="registeDate"/>
    <result column="rental_home_rule" property="rentalHomeRule"/>
    <result column="clean_fee" property="cleanFee"/>

    <association property="region" javaType="Region">
      <id column="region_no" property="regionNo"/>
    </association>

  </resultMap>

  <!-- 숙소 목록 검색(추천수) -->
  <select id="rentalHomeDefaultSelect" resultMap="rentalHomeSearch">
    select
      t1.rental_home_no,
      t1.name,
      t1.price,
      t2.uuid_photo_name,
      t2.photo_no,
      t2.photo_order,
      t1.lat,
      t1.lon,
      (
        select
          count(*)
        from
          rental_home_like
        where
          t1.rental_home_no = rental_home_no
      ) as like_count
    from
      rental_home t1
      inner join rental_home_photo t2 on t2.rental_home_no = t1.rental_home_no
    order by
      like_count desc
  </select>

  <!-- 숙소 테마 검색(선호 사항 선택한 유저의 숙소 출력) -->
  <select id="rentalHomeSelectForMember" resultMap="rentalHomeSearch" parameterType="java.util.List">
    select
      t2.uuid_photo_name,
      t1.rental_home_no,
      t2.photo_no,
      t2.photo_order,
      t1.name,
      t1.price,
      t1.lat,
      t1.lon,
      (
        select
          count(*)
        from
          rental_home_like
        where
          t1.rental_home_no = rental_home_no
      ) as like_count
    from
      rental_home t1
      inner join rental_home_photo t2 on t2.rental_home_no = t1.rental_home_no
      inner join rental_home_theme t4 on t4.rental_home_no = t1.rental_home_no
    where (t4.theme_no) in (
      select
        theme_no
      from
        theme
      where
        theme_name =
        <foreach collection="list" item="item" separator="OR">
          #{item.themeName}
        </foreach>
      )
    order by
      like_count desc
  </select>

  <!-- 숙소 테마 검색 -->
  <select id="rentalHomeThemeSelect" resultMap="rentalHomeSearch" parameterType="String">
    select
      t2.uuid_photo_name,
      t1.rental_home_no,
      t2.photo_no,
      t2.photo_order,
      t1.name,
      t1.price,
      t1.lat,
      t1.lon,
      (
        select
          count(*)
        from
          rental_home_like
        where
          t1.rental_home_no = rental_home_no
      ) as like_count
    from
      rental_home t1
      inner join rental_home_photo t2 on t2.rental_home_no = t1.rental_home_no
      inner join rental_home_theme t4 on t4.rental_home_no = t1.rental_home_no
    where (t4.theme_no) in (
      select
        theme_no
      from
        theme
      where
        theme_name = #{themeName}
      )
    order by
      like_count desc
  </select>

  <!-- 숙소 위치&날짜&수용인원 검색 -->
  <select id="rentalHomeConditionSelect" resultMap="rentalHomeSearch">
    select
      t2.uuid_photo_name,
      t2.photo_no,
      t2.photo_order,
      t1.rental_home_no,
      t1.name,
      t1.price,
      t1.lat,
      t1.lon,
      (
        select
          count(*)
        from
          rental_home_like
        where
          t1.rental_home_no = rental_home_no
      ) as like_count
    from
      rental_home t1
      inner join rental_home_photo t2 on t2.rental_home_no = t1.rental_home_no
      inner join region t4 on t4.region_no = t1.region_no
    where
      (t4.region_no) in (
         select
           region_no
         from
           region
      <if test="!regionName.equalsIgnoreCase('all')">
         where
           region_name = #{regionName}
      </if>
      )
       and
    <if test="checkInDate != null and checkOutDate != null">
      1 <![CDATA[ > ]]>
      ( select
        count(*)
      from
        reservation
      where
        <![CDATA[ start_date <= #{checkOutDate} ]]> and
        <![CDATA[ end_date >= #{checkInDate} ]]>
      )
    </if>
    <if test="( (checkInDate != null and checkOutDate != null))">
      and
    </if>
      <![CDATA[ t1.capacity >= #{capacity} ]]>
    order by
      like_count desc
  </select>

  <!-- 필터 검색 -->
  <select id="rentalHomeFilterSelect" resultMap="rentalHomeSearch">
    select
      t1.rental_home_no,
      t1.name,
      t1.price,
      t1.lat,
      t1.lon,
      t2.photo_no,
      t2.uuid_photo_name,
      t2.photo_order,
      (
        select
        count(*)
        from
        rental_home_like
        where
        t1.rental_home_no = rental_home_no
      ) as like_count
      from
        rental_home t1
        inner join rental_home_photo t2 on t2.rental_home_no = t1.rental_home_no
      where
      <if test="theme != null">
        t1.rental_home_no in (
          select
            t4.rental_home_no
          from
            rental_home_theme t4
          where
            t4.theme_no = (
              select
                theme_no
              from
                theme
              where
                theme_name =
              <foreach collection="theme" item="item" separator="OR">
                #{item.themeName}
              </foreach>
          )
        )
      </if>
      <if test="theme != null and ((minPrice > 0 and maxPrice > 0 ) or capacity > 0 )">
        and
      </if>
      <if test="minPrice != null and maxPrice != null">
        ( t1.price between #{minPrice} and #{maxPrice} )
      </if>
      <if test="theme != null and ((minPrice > 0 and maxPrice > 0 ) or capacity > 0 )">
        and
      </if>
      <if test="capacity > 0">
        <![CDATA[ t1.capacity >= #{capacity} ]]>
      </if>
    <if test="theme != null and ((minPrice > 0 and maxPrice > 0 ) or capacity > 0 ) and rentalHomeFacilities != null">
      and
    </if>
    <if test="rentalHomeFacilities != null">
      t1.rental_home_no in (
        select
          t5.rental_home_no
        from
          rental_home_detail t5
        where
          t5.facility_no = (
            select
              facility_no
            from
              rental_home_facility
            where
              rental_home_facility =
            <foreach collection="rentalHomeFacilities" item="item" separator="OR">
              #{item.facilityName}
            </foreach>
        )
      )
    </if>
  </select>
  <!-- 숙소 상세 조회 -->
  <select id="rentalHomeDetailSelect" resultMap="rentalHomeView" parameterType="int">
    select
      t1.rental_home_no,
      t1.region_no,
      t1.name,
      t1.explanation,
      t1.address,
      t1.price,
      t1.capacity,
      t1.lat,
      t1.lon,
      t1.state,
      t1.hosting_start_date,
      t1.hosting_end_date,
      t1.registe_date,
      t1.rental_home_rule,
      t1.clean_fee
    from
      rental_home t1
    where
      t1.rental_home_no = #{rental_home_no}
  </select>

  <!-- 숙소 사진 조회 -->
  <select id="rentalHomePhotoSelect" resultMap="rentalHomePhotos">
    select
      photo_no,
      ori_photo_name,
      uuid_photo_name,
      photo_explanation,
      photo_order
    from
      rental_home_photo
    where
      rental_home_no = #{rental_home_no}
    order by
      photo_order
  </select>

  <!-- 숙소 리뷰 조회  -->
  <select id="rentalHomeReviewSelect" resultMap="rentalHomeReview" parameterType="int">
    select
      t2.created_date,
      t2.score,
      t2.review
    from
      reservation t1
      inner join rental_home_review t2 on t1.reservation_no = t2.reservation_no
    where
      t1.rental_home_no = #{rental_home_no}
    order by
      t2.created_date desc;
  </select>

  <!-- 숙소 편의 시설 조회 -->
  <select id="rentalHomeFacilitySelect" resultMap="rentalHomeFacilityMap">
    select
      t3.facility_no,
      t3.facility_count,
      t4.facility_name
    from
      rental_home_detail t3
      inner join rental_home_facility t4 on t4.facility_no = t3.facility_no
    where
      t3.rental_home_no = #{rental_home_no}
  </select>

  <!-- 테마 전체 검색 -->
  <select id="getAllThemes" resultMap="themeMap">
    select
      theme_no,
      theme_name
    from
      theme
    order by
      theme_no
  </select>

  <!-- 숙소 리뷰 작성 -->
  <insert id="rentalHomeReviewAdd" parameterType="RentalHomeReview">
    insert into
      rental_home_review
      (
        reservation_no,
        score,
        review,
      )
    values
      (
        #{reservation_no},
        #{score},
        #{review}
      )
  </insert>


  <!-- 숙소 신고 -->
  <insert id="rentalHomeReportAdd" parameterType="RentalHomeReport">
    insert into
      rental_home_report
      (
        rental_home_no,
        member_no,
        content,
        report_category_no
      )
    values
      (
        #{rentalHomeNo},
        #{memberNo},
        #{content},
        #{reportCategoryNo}
      )
  </insert>

</mapper>